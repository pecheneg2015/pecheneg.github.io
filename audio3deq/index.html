<!DOCTYPE html>
<!--[if lt IE 7]><html lang="ru" class="lt-ie9 lt-ie8 lt-ie7"><![endif]-->
<!--[if IE 7]><html lang="ru" class="lt-ie9 lt-ie8"><![endif]-->
<!--[if IE 8]><html lang="ru" class="lt-ie9"><![endif]-->
<!--[if gt IE 8]><!-->
<html lang="ru">
<!--<![endif]-->

<head>
    <meta charset="utf-8" />
    <title>Заголовок</title>
    <meta content="" name="description" />
    <meta content="" property="og:image" />
    <meta content="" property="og:description" />
    <meta content="" property="og:site_name" />
    <meta content="website" property="og:type" />

    <meta content="telephone=no" name="format-detection" />
    <meta http-equiv="x-rim-auto-match" content="none">

    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    <link rel="stylesheet" href="libs/bootstrap/bootstrap-grid-3.3.1.min.css" />
    <link rel="stylesheet" href="css/main.css" />
</head>
<body>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/85/three.min.js"></script>
    <script src="libs/Mirror.js"></script>
       
    <script>     
    /*          СОЗДАЁМ ОБЪЕКТ АУДИО            */
    var audio = new Audio();
    audio.src = '3.mp3';
    audio.controls = true;
    audio.autoplay = false;
    audio.volume = 0.1;
    audio.id = "aud";
    document.body.appendChild(audio);
    /*     ВОЗНЯ СО ЗВУКОМ     */
     if('webkitAudioContext' in window) {
          var audioCtx = new webkitAudioContext();
          fetchSounds();
     }else{
        var audioCtx = new AudioContext();
     }
    
    var analyser = audioCtx.createAnalyser();
    window.addEventListener('load', function(e) {
        var source = audioCtx.createMediaElementSource(audio);
        source.connect(analyser);
        analyser.connect(audioCtx.destination);
    }, false);
    analyser.fftSize = 64;
    var size = Math.floor(analyser.fftSize/2);
    var bufferLength = analyser.frequencyBinCount;
    var dataArray = new Uint8Array(bufferLength);
    var frequencyData = new Uint8Array(size);
    /*          РАБОТА СО СЦЕНОЙ        */
    var scene = new THREE.Scene(); // создаём новую сцену
    var camera = new THREE.PerspectiveCamera( 100, window.innerWidth/window.innerHeight, 0.1, 1000 ); // добавляем камеру. Немного её поворачиваем и поворачиваем
        camera.position.y=5;
        camera.position.x=-4;
        camera.rotation.x =0 * Math.PI / 180;
        camera.rotation.y = -45* Math.PI / 180	
        var renderer = new THREE.WebGLRenderer({ antialias: true });// создаём объект,в котором всё будет рендериться    
        renderer.setSize( window.innerWidth, window.innerHeight );// задаём его размеры
		document.body.appendChild( renderer.domElement );//приклеиваем его к body
        /* СОЗДАЁМ КУЧУ КУБИКОВ.НАЧАЛО.*/
        var geometry = new THREE.BoxGeometry( 1, 0.01, 1 );// Определяем геометрию
        geometry.dynamic = true;
        geometry.verticesNeedUpdate = true;
        geometry.normalsNeedUpdate = true;
        geometry.dirtyColors = true;
        var cubes = [];
        var positionX = 0;
        frequencyData.forEach(function(item, i) { 
            cubes[i] =  new THREE.Mesh( geometry,  new THREE.MeshPhongMaterial( { color: 0x00ff00 } ) );
            color = i*15;
            cubes[i].material.color.setHSL( (15*i+1)/360, 1, 0.5);;
            console.log(item);
            cubes[i].position.set(positionX,0.001,0);
            positionX = positionX+1.25;
            scene.add(cubes[i])
        });
        /*        ДОБАВЛЯЕМ ИСТОЧНИК СВЕТА             */
        var light = new THREE.AmbientLight( 0xa0a0a0 ); // soft white light
        scene.add( light );
        /*          СОЗДАЁМ "ЗЕРКАЛЬНЫЙ ПОЛ"            */
        var groundMirror = new THREE.Mirror( 100, 100, { clipBias: 0.003, textureWidth: 2048, textureHeight:2048, color: 0x444444} );
        groundMirror.position.set(0,0,0);
        groundMirror.rotateX(  -Math.PI/2 );
		scene.add( groundMirror );
		camera.position.z =15;// Задаём положение камеры must be 25 
        var render = function () {
				requestAnimationFrame( render );
                analyser.getByteFrequencyData(frequencyData);
                frequencyData.forEach(function(item, i) {
                    item = 15*item;
                    item = item.toFixed(2);
                    cubes[i].material.color.setHSL( (15*i+1)/360, 0.7, 0.5);
                    cubes[i].scale.y = (item+1)/256*100;
                });
                renderer.render(scene, camera);
		};
        render();
    </script>
</body>
</html>